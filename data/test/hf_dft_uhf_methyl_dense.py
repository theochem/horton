# -*- coding: utf-8 -*-
# HORTON: Helpful Open-source Research TOol for N-fermion systems.
# Copyright (C) 2011-2016 The HORTON Development Team
#
# This file is part of HORTON.
#
# HORTON is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HORTON is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


import sys

from numpy import array, allclose
from nose.plugins.attrib import attr

from horton import context


@attr('regression_check')
def test_regression():
    ref_result_energy = -39.331221904962412
    ref_result_exp_alpha = array([[  9.86321688e-01,  -2.16601740e-01,  -1.63605483e-16,
          2.29852274e-08,   1.36511788e-18,  -1.65395919e-01,
          7.76425148e-08,  -1.70617342e-14,   8.62170150e-17,
         -1.80433622e-16,   3.34251942e-08,   6.08420569e-02,
         -1.81168400e-08,   7.64024082e-16,  -4.58234790e-02],
       [  9.44495049e-02,   2.22332098e-01,   9.47264013e-16,
         -1.40770711e-08,  -4.27496583e-18,   7.38562779e-02,
         -2.45583848e-08,   1.33911908e-14,   2.94284039e-16,
         -1.98799662e-15,   5.82414822e-08,   2.10701621e-01,
         -3.01835501e-07,  -1.58733982e-14,   1.78809927e+00],
       [ -8.50830705e-10,  -5.06501749e-08,   1.50283242e-09,
         -3.84089564e-01,  -3.76996880e-16,   1.44811823e-07,
          2.96489833e-01,  -3.58653338e-08,   3.03814328e-17,
         -4.02458611e-10,  -8.49310808e-01,   8.96827843e-08,
         -7.46120214e-01,  -6.23656274e-09,  -1.41728735e-07],
       [ -1.19651895e-17,   4.15717942e-16,  -3.84089588e-01,
         -1.50283254e-09,  -1.61769999e-16,  -1.22325337e-14,
          3.58653277e-08,   2.96489802e-01,  -2.27670254e-15,
          8.49310624e-01,  -4.02460066e-10,   4.53238172e-16,
         -6.23656344e-09,   7.46120416e-01,   5.45653402e-15],
       [  1.16413230e-19,  -7.69847168e-19,   9.33771800e-17,
          1.20558106e-16,  -5.09701218e-01,  -4.52421433e-18,
          3.11995294e-17,  -2.46965551e-16,   1.06240430e+00,
          2.94134157e-15,   3.59382825e-16,  -1.95622065e-15,
         -7.90754175e-17,  -5.43210673e-17,  -1.66476239e-17],
       [ -5.11896423e-02,   6.58761355e-01,  -1.80445165e-15,
         -1.11914992e-07,  -2.35525319e-17,   1.89301762e+00,
         -1.29045772e-06,   2.29442844e-13,  -2.77857897e-16,
          2.70534029e-15,  -3.95503880e-07,  -1.43255830e-01,
          4.27862905e-07,   2.12811954e-14,  -2.76922584e+00],
       [  3.93102917e-09,  -3.85911826e-08,   1.29072836e-09,
         -3.29880230e-01,   2.61616277e-16,   4.33952601e-07,
          1.37999567e+00,  -1.66933213e-07,  -9.27263592e-17,
          6.98355115e-10,   1.47375007e+00,   1.07391971e-07,
          8.51944005e-01,   7.12111177e-09,   3.75658935e-07],
       [  4.80364366e-17,  -1.92554567e-15,  -3.29880195e-01,
         -1.29072727e-09,  -5.01713257e-17,  -6.18791067e-14,
          1.66933218e-07,   1.37999569e+00,   3.94544203e-15,
         -1.47374972e+00,   6.98356331e-10,  -3.27056589e-15,
          7.12110693e-09,  -8.51944253e-01,  -1.26243844e-14],
       [ -5.49663190e-20,   8.02539027e-19,   6.49716708e-17,
          1.46620581e-16,  -6.31995800e-01,  -3.80606305e-17,
         -1.22497068e-16,   2.03269001e-16,  -9.94524780e-01,
         -2.72957083e-15,  -1.69845574e-16,   1.38914840e-15,
          2.81489283e-16,   3.73873498e-17,   9.61704250e-18],
       [ -1.35432407e-03,   1.18990986e-01,   9.52763599e-10,
         -2.43504474e-01,   1.03283355e-16,  -6.51719448e-02,
         -6.49959908e-02,   7.86233386e-09,   1.30905772e-15,
         -2.67212930e-10,  -5.63899835e-01,   7.37309126e-01,
          9.21532063e-01,   7.70276859e-09,  -7.21845853e-02],
       [  1.12325144e-02,   2.83166159e-02,   8.58992914e-10,
         -2.19538992e-01,  -4.25084077e-16,  -9.56106482e-01,
         -1.61013325e+00,   1.94772108e-07,  -7.99442323e-16,
         -1.03209285e-10,  -2.17807801e-01,  -4.61391925e-01,
         -1.25669023e+00,  -1.05042471e-08,   7.15617143e-01],
       [ -1.35432576e-03,   1.18991046e-01,  -2.10881082e-01,
          1.21752237e-01,  -9.50684131e-17,  -6.51718588e-02,
          3.24979801e-02,  -5.62881961e-02,  -7.21158418e-16,
          4.88351793e-01,   2.81950159e-01,   7.37308611e-01,
         -4.60766303e-01,  -7.98070291e-01,  -7.21848187e-02],
       [  1.12325205e-02,   2.83166064e-02,  -1.90126338e-01,
          1.09769468e-01,   1.97811664e-16,  -9.56105706e-01,
          8.05067386e-01,  -1.39441705e+00,  -1.08611529e-15,
          1.88626809e-01,   1.08903967e-01,  -4.61391220e-01,
          6.28345105e-01,   1.08832580e+00,   7.15617755e-01],
       [ -1.35432576e-03,   1.18991046e-01,   2.10881081e-01,
          1.21752238e-01,  -4.60935588e-17,  -6.51718588e-02,
          3.24979937e-02,   5.62881882e-02,   2.37957089e-15,
         -4.88351793e-01,   2.81950159e-01,   7.37308611e-01,
         -4.60766316e-01,   7.98070283e-01,  -7.21848187e-02],
       [  1.12325205e-02,   2.83166064e-02,   1.90126337e-01,
          1.09769469e-01,   2.89058908e-16,  -9.56105706e-01,
          8.05067724e-01,   1.39441686e+00,   1.49097417e-16,
         -1.88626809e-01,   1.08903968e-01,  -4.61391220e-01,
          6.28345123e-01,  -1.08832579e+00,   7.15617755e-01]])
    ref_result_exp_beta = array([[  9.87067554e-01,  -1.96247295e-01,   9.03485237e-17,
          2.43393080e-08,   7.82100603e-18,  -1.80903077e-01,
          9.76912749e-08,   2.88946863e-14,  -1.48521907e-16,
         -3.53763503e-08,   2.28148821e-16,  -7.14307508e-02,
          2.40170968e-08,  -7.64043967e-16,   4.75448318e-02],
       [  9.22192806e-02,   2.05762376e-01,   7.61687204e-16,
         -1.55443330e-08,  -3.64554352e-17,   7.45429324e-02,
         -3.09471149e-08,  -1.71443482e-14,   2.95624688e-16,
         -5.26826919e-08,   5.21532954e-16,  -1.65801646e-01,
          2.53549890e-07,   1.90844757e-14,  -1.79488490e+00],
       [ -8.58418735e-10,  -7.15624457e-08,  -1.41642890e-09,
         -3.45819000e-01,   2.53008908e-16,   1.76266536e-07,
          2.98956857e-01,   4.08486743e-08,   9.91914599e-10,
          8.10730336e-01,  -2.30141540e-15,   1.36586786e-08,
          8.04490880e-01,   1.35966581e-08,   1.19657014e-07],
       [ -2.51900443e-17,   3.97340012e-16,  -3.45819031e-01,
          1.41642886e-09,   1.78910121e-16,  -2.30670396e-14,
          4.08486660e-08,  -2.98956826e-01,  -8.10730176e-01,
          9.91917679e-10,  -1.63269560e-15,   2.11135009e-15,
          1.35966589e-08,  -8.04491032e-01,  -5.81697820e-15],
       [  1.11905343e-19,  -7.27253452e-19,  -2.29146936e-16,
         -7.21227736e-17,  -3.33684442e-01,  -6.61355635e-18,
          4.64312815e-17,  -1.42651047e-16,  -3.18519626e-15,
          3.07204712e-15,   1.13011191e+00,   3.83269570e-15,
          6.32716636e-16,   1.26323089e-15,   5.03263407e-18],
       [ -5.22489061e-02,   5.07759958e-01,  -3.32687875e-15,
         -9.18238643e-08,  -1.62803016e-16,   1.97550198e+00,
         -1.49814697e-06,  -3.59865696e-13,  -7.53472299e-16,
          4.30921205e-07,  -5.08904605e-16,   1.39163597e-01,
         -3.45372625e-07,  -2.16220421e-14,   2.74348536e+00],
       [  4.09752878e-09,  -3.63059249e-08,  -1.10724660e-09,
         -2.70333009e-01,  -7.02207825e-16,   6.09361300e-07,
          1.42600661e+00,   1.94845749e-07,  -1.72151509e-09,
         -1.40706310e+00,   3.62610053e-15,  -2.56255260e-07,
         -9.08050410e-01,  -1.53469179e-08,  -3.52581081e-07],
       [  1.24690325e-16,  -2.33845461e-15,  -2.70332990e-01,
          1.10724758e-09,   7.30506471e-17,  -1.21468817e-13,
          1.94845755e-07,  -1.42600661e+00,   1.40706278e+00,
         -1.72151708e-09,   2.94068162e-15,  -3.46679985e-15,
         -1.53469092e-08,   9.08050571e-01,   1.28860296e-14],
       [ -4.69690792e-20,  -7.24615050e-19,  -1.17425835e-17,
         -4.55738474e-17,  -7.82561316e-01,  -8.06095680e-17,
         -8.15577590e-17,  -1.14749251e-16,   2.40764874e-15,
         -1.99133346e-15,  -8.80963118e-01,  -2.83649095e-15,
         -2.84492791e-16,  -1.13806565e-15,  -7.74104268e-18],
       [ -1.10061708e-03,   1.51152041e-01,  -1.10128174e-09,
         -2.68876398e-01,   3.83501799e-17,  -4.10200508e-02,
         -4.70221256e-02,  -6.42497559e-09,   7.50367051e-10,
          6.13305465e-01,   1.14611768e-15,  -7.34498227e-01,
         -8.83218019e-01,  -1.49272174e-08,   5.67891313e-02],
       [  1.13782716e-02,   9.02370444e-02,  -1.16125783e-09,
         -2.83519494e-01,   6.27258216e-16,  -9.66383168e-01,
         -1.61151939e+00,  -2.20193648e-07,   1.57133769e-10,
          1.28431993e-01,  -2.11604927e-15,   4.62836788e-01,
          1.25441770e+00,   2.12008506e-08,  -6.95465259e-01],
       [ -1.10061859e-03,   1.51152123e-01,  -2.32853795e-01,
          1.34438177e-01,  -2.28932003e-16,  -4.10199678e-02,
          2.35110359e-02,   4.07223640e-02,  -5.31138251e-01,
         -3.06652916e-01,   4.18311372e-16,  -7.34497693e-01,
          4.41609333e-01,   7.64889415e-01,   5.67893305e-02],
       [  1.13782778e-02,   9.02370616e-02,  -2.45535046e-01,
          1.41759684e-01,  -1.13781286e-16,  -9.66382183e-01,
          8.05760583e-01,   1.39561758e+00,  -1.11225172e-01,
         -6.42161203e-02,   1.14567165e-16,   4.62835940e-01,
         -6.27208904e-01,  -1.08635775e+00,  -6.95465824e-01],
       [ -1.10061859e-03,   1.51152123e-01,   2.32853796e-01,
          1.34438175e-01,  -1.05410712e-16,  -4.10199678e-02,
          2.35110470e-02,  -4.07223576e-02,   5.31138250e-01,
         -3.06652917e-01,   5.32341274e-15,  -7.34497693e-01,
          4.41609359e-01,  -7.64889400e-01,   5.67893305e-02],
       [  1.13782778e-02,   9.02370616e-02,   2.45535048e-01,
          1.41759682e-01,  -4.60295199e-17,  -9.66382183e-01,
          8.05760964e-01,  -1.39561736e+00,   1.11225172e-01,
         -6.42161206e-02,  -2.22634757e-15,   4.62835940e-01,
         -6.27208941e-01,   1.08635773e+00,  -6.95465824e-01]])

    thresholds = {'ref_result_exp_alpha': 1e-08, 'ref_result_energy': 1e-08, 'ref_result_exp_beta': 1e-08}

    test_path = context.get_fn("examples/hf_dft/uhf_methyl_dense.py")

    l = {}
    m = locals()
    with open(test_path) as fh:
        exec fh in l

    for k,v in thresholds.items():
        var_name = k.split("ref_")[1]
        assert allclose(l[var_name], m[k], v), m[k] - l[var_name]

if __name__ == "__main__":
    test_regression()
