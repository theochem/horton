Atoms-in-Molecules (AIM) analysis
#################################


.. contents::


Introduction
============

Horton supports several real-space atoms-in-molecules (AIM) schemes. A
wavefunction or an electronic density on a grid can be loaded from several
file formats. With this input, several AIM schemes can be used to derive AIM
observables, e.g. atomic charge, atomic multipole expansion, etc.

Horton supports two different approaches to perform the partitioning: WPart
(based on wavefunction files) and CPart (based on cube files). Both
implementations build on the same algorithms but use different types of
grids for the numerical integrals. An overview of both implementations is
given in the following table:

======================== =========================== =========================== ============
Feature                  WPart                       CPart                       References
======================== =========================== =========================== ============
Command-line script      ``horton-wpart.py``         ``horton-cpart.py``
**Boundary conditions**
0D                       X                           X
1D                                                   X
2D                                                   X
3D                                                   X
**Input file formats**
Gaussian03/09 fchk       X                                                       http://www.gaussian.com/
Molekel (Orca)           X                                                       http://cec.mpg.de/forum/
Molden input (Orca)      X                                                       http://cec.mpg.de/forum/
Gaussian03/09 cube                                   X                           http://www.gaussian.com/
Vasp CHGCAR                                          X                           https://www.vasp.at/
**AIM schemes**
Becke                    X                                                       [becke1988_multicenter]_
Hirshfeld                X                           X                           [hirshfeld1977]_
Iterative Hirshfeld      X                           X                           [bultinck2007]_
Iterative Stockholder    X                                                       [lillestolen2008]_
Extended Hirshfeld       X                           X                           [verstraelen2013]_
**AIM properties**
Charges                  X                           X
Spin charges             X
Cartesian multipoles     X                           X
Pure/harmonic multipoles X                           X
Radial moments           X                           X
Dispersion coefficients  X                           X                           [tkatchenko2009]_
**Extra options**
Symmetry analysis                                    X
======================== =========================== =========================== ============

Note that Gaussian cube files can be generated with many other codes like CPMD, ADF,
Siesta, Crystal, etc. The output of all these program should be compatible with
Horton. Horton can partition all-electron and pseudo-potential wavefunctions.
However, for all-electron partitioning with CPart, very fine grids are required.

For all the Hirshfeld variants, one must first set up a database of proatomic
densities, preferably at the same level of theory used for the molecular
computation. The script ``horton-atomdb.py`` facilitate the setup of such a
database.

All output generated by Horton is written to `HDF5
<http://www.hdfgroup.org/HDF5/>`_ files (with extension ``.h5``). These are
binary (compact) platform-independent files that can be post-processed easily
with Python scripts. The script ``horton-hdf2csv.py`` can be used to convert
(part of) an HDF5 file into the "comma-separated value" (CSV) format, which is
supported by most spreadsheet software.

The usage of the four scripts (``horton-atomdb.py``, ``horton-wpart.py``,
``horton-cpart.py`` and ``horton-hdf2csv.py``) will be discussed in the
following sections. All scripts have a ``--help`` option that prints out a
complete list of all options. The last section shows how one can use the
partitioning code through the Python interface.


``horton-atomdb.py`` -- Set up a database of proatoms
=====================================================

The usage of the script ``horton-atomdb.py`` consists of three steps:

1) **Generate input files** for isolated atom computations for one of the following
   codes: Gaussian03/09, Orca, ADF or CP2K. The following example generates
   Gaussian09 inputs for hydrogen, carbon, nitrogen and oxygen::

    horton-atomdb.py input g09 1,6-8 template.com

   The file ``template.com`` is used to generate the input files and will
   be discussed in detail below. A series of directories is created with input
   files for the atomic computations: ``001__h_001_q+00``, ``001__h_002_q-01``,
   ``001__h_003_q-02``, ... Optional arguments can be used to control the range
   of cations and anions, the spin multiplicities considered, etc. Also a script
   ``run_g09.sh`` is present that takes care of the next step.

   Run ``horton-atomdb.py input --help`` to obtain a complete list of all
   options.

2) **Run the atomic computations.** Just execute the ``run_PROGRAM.sh`` script.
   In this case::

    ./run_g09.sh

3) **Convert the output** of the external programs into a database of
   spherically averaged pro-atom densities (``atoms.h5``). Just run::

    ./horton-atomdb.py convert

   This script also generates figures of the radial densities and Fukui functions
   if ``matplotlib`` is installed.

One may remove some directories with atomic computations before or after
executing the ``run_PROGRAM.sh`` script. The corresponding atoms will not be
included in the database. Similarly, one may rerun ``horton-atomdb.py input``
to generate more input files. In that case ``run_PROGRAM.sh`` will only consider
the atomic computations that are not completed yet.


Template files
--------------

A template file is simply an input file for an atomic computation, where the
critical parameters (element, charge, ...) are replaced keys that are recognized
by the input generator of ``horton-atomdb.py``. These keys are:

* ``${element}``: The element symbol of the atom.
* ``${number}``: The element number of the atom.
* ``${charge}``: The charge of the atom (or kation, or anion).
* ``${mult}``: The spin multiplicity of the atom

For the more advanced cases, one may include (parts of) other files with generic
keys, e.g. for basis sets that are different for every element:

* ``${file:filename}``: This is replaced by the contents of
  ``filename.NNN_PPP_MM``, where ``NNN`` is the element number, ``PPP`` is the
  atomic population and ``MM`` is the spin multiplicity. These numbers are
  left-padded with zeros to fix the the length. If a field in the filename is
  zero, it is considered as a wild card. For example, one may use
  ``${file:basis}`` in the template file and store a basis set specification for
  oxygen in the file ``basis.008_000_00``.

* ``${line:filename}``. This comparable to the previous, except that all
  replacements are stored in one file. Each (non-empty) line in that file starts
  with ``NNN_PPP_MM``, which is then followed by the string that will be filled
  into the field.

None of the keys is mandatory, although ``${element}`` (or ``${number}``,
``${charge}`` and ``${mult}`` must be present to obtain sensible results.


Simple template file for Gaussian 03/09
---------------------------------------

Thia is a basic template file for atomic computations at the HF/3-21G level::

    %chk=atom.chk
    #p HF/3-21G scf(xqc)

    A random title line

    ${charge} ${mult}
    ${element} 0.0 0.0 0.0

Do not forget to include an empty line at the end. Otherwise, Gaussian will
complain. The first line ``%chk=atom.chk`` is required to read in the atomic
wavefunction in the ``convert`` step of ``horton-atomdb.py``.


Advanced template file for Gaussian 03/09
-----------------------------------------

When custom basis sets are specified with the ``Gen`` keyword in Gaussian, one
has to use keys that include other files. For a database with H, C and O, one
could use the following template:

* ``template.com``::

    %chk=atom.chk
    #p PBE1PBE/Gen scf(xqc)

    A random title line

    ${charge} ${mult}
    ${element} 0.0 0.0 0.0

    ${file:basis}

* ``basis.001_000_00``::

    H 0
    6-31G(d,p)
    ****

* ``basis.006_000_00``::

    C 0
    6-31G(d,p)
    ****

* ``basis.008_000_00``::

    O     0
    S   6   1.00
       8588.5000000              0.00189515
       1297.2300000              0.0143859
        299.2960000              0.0707320
         87.3771000              0.2400010
         25.6789000              0.5947970
          3.7400400              0.2808020
    SP   3   1.00
         42.1175000              0.1138890              0.0365114
          9.6283700              0.9208110              0.2371530
          2.8533200             -0.00327447             0.8197020
    SP   1   1.00
          0.9056610              1.0000000              1.0000000
    SP   1   1.00
          0.2556110              1.0000000              1.0000000
    SP   1   1.00
          0.0845000              1.0000000              1.0000000
    D   1   1.00
          5.1600000              1.0000000
    D   1   1.00
          1.2920000              1.0000000
    D   1   1.00
          0.3225000              1.0000000
    F   1   1.00
          1.4000000              1.0000000
    ****


Simple template file for ORCA
-----------------------------

The following template file use the built-in ``cc_pVQZ`` basis set of ORCA::

    !HF TightSCF

    %basis
      Basis cc_pVQZ
    end

    *xyz ${charge} ${mult}
    ${element} 0.0 0.0 0.0
    *


Simple template file for ADF
----------------------------

This is a simple template for ADF::

    Title atomic PBE/DZP (all-electron) single point calculation

    ATOMS
      ${element}        0.00000        0.00000        0.00000
    END

    CHARGE  ${charge}

    SYMMETRY tol=1e-2

    BASIS
      Type DZP
      Core None
    END

    XC
      GGA PBE
    END

    INTEGRATION
      accint  6.0
    END

    SCF
      iterations  100
      converge 1.0e-06 1.0e-06
    END

    EXACTDENSITY

Since Horton supports (for now) only Gaussian-type basis sets, the atomic
density is computed on a grid with the auxiliary tools of ADF. These grid data are
loaded in the ``convert`` step of ``horton-atomdb.py`` to compute the
spherically averaged isolate atom densities.


Template file for CP2K
----------------------

One must use ``CP2K`` version 2.4-r12857 (or newer). The computation of proatoms
with ``CP2K`` is more involved because one has to specify the occupation
of each subshell. The ``ATOM`` program of ``CP2K`` does not simply follow the Aufbau
rule to assign to orbital occupations. For now, only the computation of atomic
densities with contracted basis sets and pseudopotentials is supported, mainly
because this is case where ``CP2K`` offers additional functionality.

The following example can be used to generator a proatomic database with the
elements, O, Na, Al and Si with the GTH pseudopotential and the MolOpt basis
set.

* ``template.inp``::

    &GLOBAL
      PROJECT ATOM
      PROGRAM_NAME ATOM
    &END GLOBAL
    &ATOM
      ATOMIC_NUMBER ${number}
      ELECTRON_CONFIGURATION (${mult}) CORE ${line:valence.inc}
      CORE none

      MAX_ANGULAR_MOMENTUM 1
      &METHOD
         METHOD_TYPE UKS
         &XC
           &XC_FUNCTIONAL PBE
           &END XC_FUNCTIONAL
         &END XC
      &END METHOD
      &POTENTIAL
          PSEUDO_TYPE GTH
          POTENTIAL_FILE_NAME ../../PBE_PSEUDOPOTENTIALS
          POTENTIAL_NAME ${line:ppot.inc}
      &END POTENTIAL
      &PP_BASIS
          BASIS_SET_FILE_NAME ../../BASIS_MOLOPT
          BASIS_TYPE CONTRACTED_GTO
          BASIS_SET DZVP-MOLOPT-SR-GTH
      &END PP_BASIS
      &PRINT
        &BASIS_SET ON
        &END
        &ORBITALS ON
        &END
        &POTENTIAL ON
        &END
      &END
    &END ATOM

* ``ppot.inc``::

    008_000_00 GTH-PBE-q6
    011_000_00 GTH-PBE-q9
    013_000_00 GTH-PBE-q3
    014_000_00 GTH-PBE-q4

* ``valence.inc``::

    008_005_02 1s2 2p1
    008_006_03 1s2 2p2
    008_007_04 1s2 2p3
    008_008_03 1s2 2p4
    008_009_02 1s2 2p5
    008_010_01 1s2 2p6

    011_005_02 1s2 2p1
    011_006_03 1s2 2p2
    011_007_04 1s2 2p3
    011_008_03 1s2 2p4
    011_009_02 1s2 2p5
    011_010_01 1s2 2p6
    011_011_02 1s2 2p6 2s1
    011_012_01 1s2 2p6 2s2
    011_013_02 1s2 2p6 2s2 3p1

    013_011_02 1s1
    013_012_01 1s2
    013_013_02 1s2 2p1
    013_014_03 1s2 2p2

    014_011_02 1s1
    014_012_01 1s2
    014_013_02 1s2 2p1
    014_014_03 1s2 2p2


``horton-wpart.py`` -- AIM analysis based on a wavefunction file
================================================================

The basic usage of ``horton-wpart.py`` is as follows::

    horton-wpart.py wfn {b,h,hi,he} [atoms.h5]

The ``wfn`` argument can be a Gaussian03 or 09 formatted checkpoint file, a
Molekel file or a Molden input file. The second argument refers to the
partitioning scheme:

* ``b``: Becke partitioning. [becke1988_multicenter]_
* ``h``: Hirshfeld partitioning. [hirshfeld1977]_
* ``hi``: Iterative Hirshfeld partitioning. [bultinck2007]_
* ``is``: Iterative Stockholder partitioning. [lillestolen2008]_
* ``he``: Extended Hirshfeld partitioning. [verstraelen2013]_

The ``atoms.h5`` argument is only needed for the Hirshfeld variants, not for
``b`` and ``is``. This script computes atomic weight functions and then derives
all AIM observables that are implemented for that scheme. These results are
stored in a HDF5 file with the same name as the ``wfn`` file but with a ``.h5``
extension appended. In this HDF5 file, the results are written in the group
``wpart/${SCHEME}`` where ``${SCHEME}`` is any of ``b``, ``h``, ``hi``, ``is``,
``he``.

Run ``horton-wpart.py --help`` to get a complete list of all command-line
options.

.. note::

    When a post Hartree-Fock level is used in Gaussian 03/09 (MP2, MP3, CC or
    CI), one must add the keyword ``Density=current`` to the commands in the
    input file. This is needed to have the corresponding density matrix in the
    formatted checkpoint file. When such a post HF density matrix is present,
    Horton will load that density matrix instead of the SCF density matrix. Also
    note that for some levels of theory, no 1RDM is constructed, including MP4,
    MP5, ZINDO and QCISD(T).


``horton-cpart.py`` -- AIM analysis based on a cube file
========================================================

The basic usage of ``horton-cpart.py`` is as follows::

    horton-cpart.py cube {h,hi,he} atoms.h5

The ``cube`` argument can be a Gaussian03 or 09 cube file or a VASP CHGCAR file.
The second argument refers to the partitioning scheme:

* ``h``: Hirshfeld partitioning. [hirshfeld1977]_
* ``hi``: Iterative Hirshfeld partitioning. [bultinck2007]_
* ``he``: Extended Hirshfeld partitioning. [verstraelen2013]_

This script
computes atomic weight functions and then derives all AIM observables that are
implemented for that scheme. These results are stored in a HDF5 file with
the same name as the ``cube`` file but with a ``.h5`` extension appended. In this
HDF5 file, the results are written in the group ``cpart/${SCHEME}_r${STRIDE}`` where
``${SCHEME}`` is any of ``h``, ``hi``, ``he`` and ``${STRIDE}`` is an optional
argument of the script ``horton-cpart.py`` that is discussed below.

The ``horton-cpart.py`` script is somewhat experimental. Always make sure that the
numbers have converged with an increasing number of grid points. One may need to
following options to control the efficiency of the program

* ``--compact COMPACT``. Automatically determine cutoff radii for the pro-atoms,
  where ``COMPACT`` is the maximum number of electrons lost in the tail after
  the cutoff radius. 0.001 is typically a reasonable value for ``COMPACT``. The
  pro-atoms are renormalized after setting the cutoff radii. One cutoff radius
  is defined per element. This implies that the tail of the most diffuse anion
  determines the cutoff radius when the ``--compact`` option is used.

* ``--greedy``. This enables a more memory-hungry version of the Iterative and
  Extended Hirshfeld algorithms that runs considerably faster. This becomes
  unfeasible for systems with huge unit cells.

* ``--stride STRIDE``. The ``STRIDE`` parameter controls the subsampling of the
  cube file prior to the partitioning. It is ``1`` by default.

Run ``horton-cpart.py --help`` to get a complete list of all command-line
options.


``horton-hdf2csv.py`` -- Conversion of HDF5 files to CSV format
===============================================================

The script ``horton-hdf2csv.py`` is used as follows::

    horton-hdf2csv.py somefile.h5:path/in/hdf5/file otherfile.csv

For example, if ``horton-wpart.py`` was used to run an Extended Hirshfeld
partitioning of a wavefunction in ``gaussian.fchk``, then the following would
convert the results into CSV format::

    horton-hdf2csv.py gaussian.fchk.h5:wpart/he extended_hirshfeld.csv

This script was added for the sake of convenience for those who are not capable
of processing the HDF5 output generated by the Horton scripts. If you know how,
please process the HDF5 files directly with custom scripts. That is far easier
than interfacing to the CSV files that this script generates. The `h5py
<http://www.h5py.org/ library>`_ library is a great tool to make such custom
scripts.


Python interface to the partitioning code
=========================================

The ``horton-wpart.py`` and ``horton-cpart.py`` scripts have a rather intuitive
Python interface that allows one to run a more customized analysis. The script
``data/examples/004_wpart/run.py`` is a simple example that runs a Becke partitioning
where only the charges are computed and written to a simple text file.

.. literalinclude:: ../data/examples/004_wpart/run.py

The unit tests in the source code contain many small examples that can be used
as a starting point for similar scripts. These unit tests can be found in
``horton/part/test/test_wpart.py`` and ``horton/part/test/test_cpart.py``.
